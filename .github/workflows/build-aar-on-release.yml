name: Build & Publish AAR

on:
  release:
    types: [created]

permissions:
  contents: write    # 用於上傳 Release Asset
  packages: write    # 用於上傳 GitHub Packages

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 檢出代碼
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ 設置 JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3️⃣ 賦予 gradlew 執行權限
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 4️⃣ 從 Tag 提取版本號 (例如 v1.0.1 -> 1.0.1)
      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 5️⃣ 編譯 Release AAR
      - name: Build Release AAR
        run: ./gradlew :google-place-api-wrapper:assembleRelease -Pversion=${{ steps.version.outputs.version }}

      # 6️⃣ 準備發布用的 AAR (使用 cp 而不是 mv，確保原始路徑檔案還在)
      - name: Prepare AAR for Release Asset
        run: |
          AAR_PATH=$(find google-place-api-wrapper/build/outputs/aar/ -name "*release.aar" | head -n 1)
          cp "$AAR_PATH" "google-place-api-wrapper-${{ steps.version.outputs.version }}.aar"

      # 7️⃣ 上傳 AAR 到 GitHub Release 頁面
      - name: Upload AAR to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            google-place-api-wrapper-${{ steps.version.outputs.version }}.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8️⃣ 發布 AAR 到 GitHub Packages
      - name: Publish to GitHub Packages
        run: |
          # 建立臨時的 init.gradle (使用 Groovy 語法)
          cat <<EOF > publish.init.gradle
          allprojects {
              apply plugin: 'maven-publish'
          
              publishing {
                  publications {
                      maven(MavenPublication) {
                          groupId = 'com.aya'
                          artifactId = 'google-place-api-wrapper'
                          version = '${{ steps.version.outputs.version }}'
          
                          // 指向 assembleRelease 產出的原始位置
                          artifact("\${project.projectDir}/build/outputs/aar/google-place-api-wrapper-release.aar")
                      }
                  }
                  repositories {
                      maven {
                          name = "GitHubPackages"
                          url = uri("https://maven.pkg.github.com/Ayaa17/google-place-api-wapper-android")
                          credentials {
                              username = System.getenv("GITHUB_ACTOR")
                              password = System.getenv("GITHUB_TOKEN")
                          }
                      }
                  }
              }
          }
          EOF
          
          # 執行發布指令
          ./gradlew :google-place-api-wrapper:publish -I publish.init.gradle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}